{% extends "base.html" %}

{% block content %}
  <h1>Your Playlists</h1>
  <div class="actions">
    <a class="btn secondary" href="{{ url_for('logout') }}">Disconnect</a>
  </div>
  <div class="meta">
    Total playlists: {{ total_playlists }} · Total videos: <span id="total-videos">{{ total_videos }}</span>
    · API calls used (session): {{ api_calls_used }}
    {% if api_calls_remaining is not none %}
      · Estimated remaining: {{ api_calls_remaining }}
    {% endif %}
  </div>
  <form method="get">
    <div class="actions">
      <label>
        Sort by
        <select name="sort">
          <option value="title" {% if sort_by == "title" %}selected{% endif %}>Title</option>
          <option value="count" {% if sort_by == "count" %}selected{% endif %}>Video count</option>
        </select>
      </label>
      <label>
        Order
        <select name="order">
          <option value="asc" {% if sort_order == "asc" %}selected{% endif %}>Ascending</option>
          <option value="desc" {% if sort_order == "desc" %}selected{% endif %}>Descending</option>
        </select>
      </label>
      <button class="btn" type="submit">Apply</button>
    </div>
    <div class="actions">
      <label>
        Max videos
        <input type="number" id="count-threshold" min="0" step="1" placeholder="e.g. 10">
      </label>
      <button class="btn secondary" type="button" id="select-by-count">Select ≤ X</button>
    </div>
    <div class="actions">
      <label>
        Search
        <input type="text" id="playlist-search" placeholder="Type to filter playlists">
      </label>
    </div>
  </form>
  {% if playlists %}
    <div class="playlist-layout">
      <div class="playlist-list-pane">
        <div class="bulk-actions actions">
          <button class="btn danger" type="button" id="delete-selected" style="display: none;" disabled>Delete selected</button>
          <button class="btn secondary" type="button" id="merge-selected" style="display: none;" disabled onclick="document.getElementById('merge-status').textContent='Merge button clicked.'; startMerge(event);">Merge selected</button>
          <span id="merge-status" class="merge-status"></span>
        </div>
        <ul class="playlist-list" id="playlist-list">
          {% for playlist in playlists %}
            <li data-playlist-id="{{ playlist.id }}" data-count="{{ playlist.contentDetails.itemCount }}">
              <input type="checkbox" class="playlist-select">
              <form method="post" class="delete-form" action="{{ url_for('delete_playlist', playlist_id=playlist.id, sort=sort_by, order=sort_order) }}">
                <button class="btn danger" type="submit">Delete</button>
              </form>
              <button class="btn secondary view-button" type="button" data-playlist-id="{{ playlist.id }}">
                View
              </button>
              <button class="btn secondary dedupe-button" type="button" data-playlist-id="{{ playlist.id }}">
                Dedupe
              </button>
              <span class="dedupe-status" aria-live="polite"></span>
              <div class="playlist-info">
                <div>
                  <strong>
                    <a class="playlist-link" href="https://www.youtube.com/playlist?list={{ playlist.id }}" target="_blank" rel="noopener noreferrer" data-title="{{ playlist.snippet.title }}">
                      {{ playlist.snippet.title }}
                    </a>
                  </strong>
                </div>
                <div class="meta">
                  {{ playlist.contentDetails.itemCount }} videos
                </div>
              </div>
            </li>
          {% endfor %}
        </ul>
      </div>
      <div class="playlist-viewer-pane">
        <div class="viewer-header">
          <div>
            <div id="playlist-viewer-title">Playlist videos</div>
            <div id="playlist-viewer-status" class="viewer-status"></div>
          </div>
          <div class="viewer-actions">
            <label>
              Destination
              <select id="transfer-destination" disabled>
                <option value="">Select playlist</option>
              </select>
            </label>
            <button class="btn secondary" type="button" id="copy-selected-videos" disabled>Copy selected</button>
            <button class="btn secondary" type="button" id="move-selected-videos" disabled>Move selected</button>
            <button class="btn danger" type="button" id="delete-selected-videos" disabled>Delete selected videos</button>
          </div>
        </div>
        <div id="playlist-viewer" class="viewer-list">
          <div class="viewer-hint">Select a playlist to load its videos.</div>
        </div>
      </div>
    </div>
  {% else %}
    <p>No playlists found.</p>
  {% endif %}

  <script>
    const viewer = document.getElementById('playlist-viewer');
    const bulkDeleteButton = document.getElementById('delete-selected');
    const mergeSelectedButton = document.getElementById('merge-selected');
    const mergeStatus = document.getElementById('merge-status');
    const playlistSearch = document.getElementById('playlist-search');
    const playlistList = document.getElementById('playlist-list');
    const totalVideosEl = document.getElementById('total-videos');
    let searchTimer = null;
    const countInput = document.getElementById('count-threshold');

    const viewerTitle = document.getElementById('playlist-viewer-title');
    const viewerStatus = document.getElementById('playlist-viewer-status');
    const deleteSelectedVideosButton = document.getElementById('delete-selected-videos');
    const copySelectedVideosButton = document.getElementById('copy-selected-videos');
    const moveSelectedVideosButton = document.getElementById('move-selected-videos');
    const transferDestinationSelect = document.getElementById('transfer-destination');
    let currentPlaylistId = null;

    function updateVideoDeleteState() {
      if (!deleteSelectedVideosButton) return;
      const anySelected = viewer.querySelectorAll('.video-select:checked').length > 0;
      deleteSelectedVideosButton.disabled = !anySelected;
    }

    function updateTransferState() {
      if (!copySelectedVideosButton || !moveSelectedVideosButton || !transferDestinationSelect) return;
      const anySelected = viewer.querySelectorAll('.video-select:checked').length > 0;
      const hasDestination = Boolean(transferDestinationSelect.value);
      copySelectedVideosButton.disabled = !anySelected || !hasDestination;
      moveSelectedVideosButton.disabled = !anySelected || !hasDestination;
    }

    function updateDestinationOptions() {
      if (!transferDestinationSelect) return;
      const options = Array.from(document.querySelectorAll('.playlist-list li'))
        .map((row) => {
          const title = row.querySelector('.playlist-link')?.textContent?.trim() || '';
          return { id: row.dataset.playlistId, title };
        })
        .filter((item) => item.id && item.id !== currentPlaylistId);
      transferDestinationSelect.innerHTML = '<option value="">Select playlist</option>';
      options.forEach((item) => {
        const option = document.createElement('option');
        option.value = item.id;
        option.textContent = item.title;
        transferDestinationSelect.appendChild(option);
      });
      transferDestinationSelect.disabled = options.length === 0;
      updateTransferState();
    }

    function loadPlaylistVideos(playlistId, playlistTitle, rowElement) {
      if (!playlistId) return;
      currentPlaylistId = playlistId;
      if (viewerTitle && playlistTitle) {
        viewerTitle.textContent = `Playlist videos: ${playlistTitle}`;
      }
      if (viewerStatus) {
        viewerStatus.textContent = '';
      }
      document.querySelectorAll('.playlist-list li').forEach((li) => {
        li.classList.remove('active');
      });
      if (rowElement) {
        rowElement.classList.add('active');
      }
      updateDestinationOptions();
      viewer.innerHTML = '<div class="viewer-hint">Loading...</div>';
      fetch(`/playlist/${playlistId}/items`)
        .then((response) => response.json())
        .then((data) => {
          if (!data.items || !data.items.length) {
            viewer.innerHTML = '<div class="viewer-hint">No videos found.</div>';
            return;
          }
          const list = document.createElement('ol');
          list.className = 'viewer-items';
          data.items.forEach((item) => {
            const title = item?.title || 'Untitled video';
            const thumbUrl = item?.thumbnail || '';
            const videoId = item?.videoId;
            const playlistItemId = item?.playlistItemId;
            const listItem = document.createElement('li');
            listItem.dataset.playlistItemId = playlistItemId || '';
            listItem.dataset.videoId = videoId || '';
            const link = document.createElement('a');
            const thumb = document.createElement('img');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'video-select';
            thumb.className = 'video-thumb';
            thumb.alt = '';
            if (thumbUrl) {
              thumb.src = thumbUrl;
            }
            link.textContent = title;
            if (videoId) {
              link.href = `https://www.youtube.com/watch?v=${videoId}`;
              link.target = '_blank';
              link.rel = 'noopener noreferrer';
            }
            checkbox.addEventListener('change', () => {
              updateVideoDeleteState();
              updateTransferState();
            });
            listItem.appendChild(checkbox);
            listItem.appendChild(thumb);
            listItem.appendChild(link);
            list.appendChild(listItem);
          });
          viewer.innerHTML = '';
          viewer.appendChild(list);
          updateVideoDeleteState();
          updateTransferState();
        })
        .catch(() => {
          viewer.innerHTML = '<div class="viewer-hint">Failed to load videos.</div>';
        });
    }

    document.querySelectorAll('.view-button').forEach((button) => {
      button.addEventListener('click', () => {
        const li = button.closest('li');
        const title = li ? li.querySelector('.playlist-link')?.textContent?.trim() : '';
        loadPlaylistVideos(button.dataset.playlistId, title, li);
      });
    });

    document.querySelectorAll('.dedupe-button').forEach((button) => {
      button.addEventListener('click', () => {
        const li = button.closest('li');
        const playlistId = li?.dataset.playlistId || button.dataset.playlistId;
        if (!playlistId) return;
        if (!confirm('Remove duplicate videos from this playlist?')) return;
        const statusEl = li ? li.querySelector('.dedupe-status') : null;
        button.disabled = true;
        const originalLabel = button.textContent;
        button.textContent = 'Removing...';
        if (statusEl) {
          statusEl.textContent = 'Removing duplicates...';
          statusEl.classList.remove('error');
        }
        fetch(`/playlist/${playlistId}/dedupe`, {
          method: 'POST',
          headers: { 'X-Requested-With': 'XMLHttpRequest' },
        })
          .then((response) => response.json())
          .then((data) => {
            if (!data.success) {
              if (statusEl) {
                statusEl.textContent = data.error || 'Failed to remove duplicates.';
                statusEl.classList.add('error');
              } else {
                alert(data.error || 'Failed to remove duplicates.');
              }
              return;
            }
            const remaining = data.remaining;
            if (li && Number.isFinite(remaining)) {
              li.dataset.count = `${remaining}`;
              const metaEl = li.querySelector('.meta');
              if (metaEl) metaEl.textContent = `${remaining} videos`;
            }
            const removedCount = data.removed || 0;
            if (totalVideosEl && Number.isFinite(removedCount)) {
              const currentTotal = parseInt(totalVideosEl.textContent || '0', 10);
              if (!Number.isNaN(currentTotal)) {
                totalVideosEl.textContent = `${Math.max(currentTotal - removedCount, 0)}`;
              }
            }
            if (currentPlaylistId === playlistId) {
              const title = li ? li.querySelector('.playlist-link')?.textContent?.trim() : '';
              loadPlaylistVideos(playlistId, title, li);
            }
            if (statusEl) {
              if (data.failures && data.failures.length) {
                statusEl.textContent = `Removed ${removedCount} duplicate(s), but some failed.`;
                statusEl.classList.add('error');
              } else {
                statusEl.textContent = `Removed ${removedCount} duplicate(s).`;
              }
              setTimeout(() => {
                statusEl.textContent = '';
                statusEl.classList.remove('error');
              }, 2000);
            }
          })
          .catch(() => {
            if (statusEl) {
              statusEl.textContent = 'Failed to remove duplicates.';
              statusEl.classList.add('error');
            } else {
              alert('Failed to remove duplicates.');
            }
          })
          .finally(() => {
            button.textContent = originalLabel;
            button.disabled = false;
          });
      });
    });

    document.querySelectorAll('.playlist-list li').forEach((row) => {
      row.addEventListener('click', (event) => {
        if (event.target.closest('button') || event.target.closest('a') || event.target.closest('input')) {
          return;
        }
        const title = row.querySelector('.playlist-link')?.textContent?.trim() || '';
        loadPlaylistVideos(row.dataset.playlistId, title, row);
      });
    });

    function applyPlaylistSearch(term) {
      const normalized = term.trim().toLowerCase();
      const rows = playlistList ? Array.from(playlistList.querySelectorAll('li')) : [];
      rows.forEach((row) => {
        const title = row.querySelector('.playlist-link')?.dataset.title || '';
        const matches = title.toLowerCase().includes(normalized);
        row.style.display = matches ? '' : 'none';
      });
    }

    if (playlistSearch) {
      playlistSearch.addEventListener('input', () => {
        if (searchTimer) {
          clearTimeout(searchTimer);
        }
        searchTimer = setTimeout(() => {
          applyPlaylistSearch(playlistSearch.value);
        }, 1000);
      });
    }

    function collectSelectedVideoItems() {
      return Array.from(viewer.querySelectorAll('.video-select:checked'))
        .map((checkbox) => checkbox.closest('li'))
        .filter(Boolean)
        .map((li) => ({
          li,
          playlistItemId: li.dataset.playlistItemId,
          videoId: li.dataset.videoId,
        }));
    }

    function updatePlaylistCount(playlistId, delta) {
      if (!playlistId || !Number.isFinite(delta)) return;
      const row = document.querySelector(`.playlist-list li[data-playlist-id="${playlistId}"]`);
      if (!row) return;
      const current = parseInt(row.dataset.count || '0', 10);
      if (Number.isNaN(current)) return;
      const next = Math.max(current + delta, 0);
      row.dataset.count = `${next}`;
      const metaEl = row.querySelector('.meta');
      if (metaEl) metaEl.textContent = `${next} videos`;
    }

    function updateTotalVideos(delta) {
      if (!totalVideosEl || !Number.isFinite(delta)) return;
      const currentTotal = parseInt(totalVideosEl.textContent || '0', 10);
      if (Number.isNaN(currentTotal)) return;
      totalVideosEl.textContent = `${Math.max(currentTotal + delta, 0)}`;
    }

    if (deleteSelectedVideosButton) {
      deleteSelectedVideosButton.addEventListener('click', () => {
        const selectedItems = collectSelectedVideoItems();
        if (!selectedItems.length || !currentPlaylistId) return;
        if (!confirm(`Remove ${selectedItems.length} video(s) from this playlist?`)) return;
        deleteSelectedVideosButton.disabled = true;
        const originalLabel = deleteSelectedVideosButton.textContent;
        deleteSelectedVideosButton.textContent = 'Deleting...';
        if (viewerStatus) {
          viewerStatus.textContent = `Removing: 0 of ${selectedItems.length}`;
        }
        const itemIds = selectedItems.map((item) => item.playlistItemId).filter(Boolean);
        fetch(`/playlist/${currentPlaylistId}/items/delete-bulk`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
          },
          body: JSON.stringify({ playlist_item_ids: itemIds }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (!data.success && data.failures && data.failures.length) {
              const failedIds = new Set(data.failures.map((item) => item.id));
              selectedItems.forEach((item) => {
                if (!failedIds.has(item.playlistItemId)) {
                  item.li.remove();
                }
              });
              alert('Some videos could not be removed.');
            } else {
              selectedItems.forEach((item) => item.li.remove());
            }
            if (viewerStatus) {
              viewerStatus.textContent = `Removing: ${selectedItems.length} of ${selectedItems.length}`;
            }
            const removedCount = data.failures && data.failures.length
              ? selectedItems.length - data.failures.length
              : selectedItems.length;
            updatePlaylistCount(currentPlaylistId, -removedCount);
            updateTotalVideos(-removedCount);
            updateVideoDeleteState();
            updateTransferState();
          })
          .catch(() => {
            alert('Failed to remove videos.');
          })
          .finally(() => {
            deleteSelectedVideosButton.textContent = originalLabel;
            if (viewerStatus) {
              setTimeout(() => {
                viewerStatus.textContent = '';
              }, 1500);
            }
            updateVideoDeleteState();
            updateTransferState();
          });
      });
    }

    if (transferDestinationSelect) {
      transferDestinationSelect.addEventListener('change', updateTransferState);
    }

    function handleTransfer(mode) {
      const selectedItems = collectSelectedVideoItems();
      if (!selectedItems.length || !currentPlaylistId) return;
      const destinationId = transferDestinationSelect?.value;
      if (!destinationId) return;
      const actionLabel = mode === 'move' ? 'Move' : 'Copy';
      if (!confirm(`${actionLabel} ${selectedItems.length} video(s) to the selected playlist?`)) return;
      const button = mode === 'move' ? moveSelectedVideosButton : copySelectedVideosButton;
      if (!button) return;
      button.disabled = true;
      const originalLabel = button.textContent;
      button.textContent = `${actionLabel}ing...`;
      if (viewerStatus) {
        viewerStatus.textContent = `${actionLabel}ing: 0 of ${selectedItems.length}`;
      }
      const payloadItems = selectedItems.map((item) => ({
        videoId: item.videoId,
        playlistItemId: item.playlistItemId,
      }));
      fetch(`/playlist/${currentPlaylistId}/items/transfer`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest',
        },
        body: JSON.stringify({
          destination_id: destinationId,
          items: payloadItems,
          mode,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (!data.success && data.failures && data.failures.length) {
            alert('Some videos could not be transferred.');
          }
          const added = data.added || 0;
          const removed = data.removed || 0;
          if (mode === 'move' && removed) {
            selectedItems.forEach((item) => {
              if (item.playlistItemId) {
                item.li.remove();
              }
            });
            updatePlaylistCount(currentPlaylistId, -removed);
            updateTotalVideos(-removed);
          }
          if (added) {
            updatePlaylistCount(destinationId, added);
            if (mode === 'copy') {
              updateTotalVideos(added);
            }
          }
          if (viewerStatus) {
            viewerStatus.textContent = `${actionLabel}ing: ${selectedItems.length} of ${selectedItems.length}`;
            setTimeout(() => {
              viewerStatus.textContent = '';
            }, 1500);
          }
          updateVideoDeleteState();
          updateTransferState();
        })
        .catch(() => {
          alert('Failed to transfer videos.');
        })
        .finally(() => {
          button.textContent = originalLabel;
          button.disabled = false;
          updateVideoDeleteState();
          updateTransferState();
        });
    }

    if (copySelectedVideosButton) {
      copySelectedVideosButton.addEventListener('click', () => handleTransfer('copy'));
    }
    if (moveSelectedVideosButton) {
      moveSelectedVideosButton.addEventListener('click', () => handleTransfer('move'));
    }

    document.querySelectorAll('.delete-form').forEach((form) => {
      form.addEventListener('submit', (event) => {
        event.preventDefault();
        if (!confirm('Delete this playlist?')) return;
        fetch(form.action, {
          method: 'POST',
          headers: { 'X-Requested-With': 'XMLHttpRequest' },
        })
          .then((response) => response.json())
          .then((data) => {
            if (!data.success) {
              alert(data.error || 'Failed to delete playlist.');
              return;
            }
            const li = form.closest('li');
            if (li) li.remove();
            updateBulkState();
          })
          .catch(() => {
            alert('Failed to delete playlist.');
          });
      });
    });

    function updateBulkState() {
      const anySelected = document.querySelectorAll('.playlist-select:checked').length > 0;
      const selectedCount = document.querySelectorAll('.playlist-select:checked').length;
      if (bulkDeleteButton) {
        bulkDeleteButton.disabled = !anySelected;
        bulkDeleteButton.style.display = anySelected ? 'inline-block' : 'none';
      }
      if (mergeSelectedButton) {
        mergeSelectedButton.disabled = selectedCount < 2;
        mergeSelectedButton.style.display = selectedCount >= 2 ? 'inline-block' : 'none';
      }
    }

    document.querySelectorAll('.playlist-select').forEach((checkbox) => {
      checkbox.addEventListener('change', updateBulkState);
    });

    const selectByCount = document.getElementById('select-by-count');
    if (selectByCount) {
      selectByCount.addEventListener('click', () => {
        const threshold = parseInt(countInput.value, 10);
        if (Number.isNaN(threshold)) {
          alert('Enter a valid number.');
          return;
        }
        document.querySelectorAll('.playlist-list li').forEach((li) => {
          const count = parseInt(li.dataset.count || '0', 10);
          const checkbox = li.querySelector('.playlist-select');
          if (checkbox) {
            checkbox.checked = count <= threshold;
          }
        });
        updateBulkState();
      });
    }

    if (bulkDeleteButton) {
      bulkDeleteButton.addEventListener('click', async () => {
        const selected = Array.from(document.querySelectorAll('.playlist-select:checked'))
          .map((checkbox) => checkbox.closest('li'))
          .filter(Boolean);
        if (!selected.length) return;
        if (!confirm(`Delete ${selected.length} playlist(s)?`)) return;
        bulkDeleteButton.disabled = true;
        const originalLabel = bulkDeleteButton.textContent;
        const total = selected.length;
        let completed = 0;
        const failures = [];
        bulkDeleteButton.textContent = `Deleting... ${completed} of ${total}`;
        for (const li of selected) {
          const playlistId = li.dataset.playlistId;
          if (!playlistId) {
            completed += 1;
            bulkDeleteButton.textContent = `Deleting... ${completed} of ${total}`;
            continue;
          }
          try {
            const response = await fetch(`/delete/${playlistId}`, {
              method: 'POST',
              headers: { 'X-Requested-With': 'XMLHttpRequest' },
            });
            const data = await response.json();
            if (data.success) {
              li.remove();
            } else {
              failures.push(playlistId);
            }
          } catch {
            failures.push(playlistId);
          }
          completed += 1;
          bulkDeleteButton.textContent = `Deleting... ${completed} of ${total}`;
        }
        if (failures.length) {
          alert('Some playlists could not be deleted.');
        }
        bulkDeleteButton.textContent = originalLabel;
        updateBulkState();
      });
    }

    async function startMerge(event) {
      if (event) {
        event.preventDefault();
      }
      if (mergeStatus) {
        mergeStatus.textContent = 'Merge button clicked.';
      }
      const selected = Array.from(document.querySelectorAll('.playlist-select:checked'))
        .map((checkbox) => checkbox.closest('li'))
        .filter(Boolean);
      if (selected.length < 2) {
        alert('Select at least two playlists to merge.');
        return;
      }
      const sorted = selected
        .map((li) => ({
          li,
          id: li.dataset.playlistId,
          count: parseInt(li.dataset.count || '0', 10),
        }))
        .sort((a, b) => b.count - a.count);
      const target = sorted[0];
      const sources = sorted.slice(1);
      mergeSelectedButton.disabled = true;
      const originalLabel = mergeSelectedButton.textContent;
      mergeSelectedButton.textContent = 'Merging...';
      const totalToTransfer = sources.reduce((sum, item) => sum + (item.count || 0), 0);
      let transferred = 0;
      if (mergeStatus) {
        mergeStatus.textContent = `Transferring: ${transferred} of ${totalToTransfer}`;
      }
      let hasFailures = false;
      for (let i = 0; i < sources.length; i += 1) {
        const source = sources[i];
        const isLast = i === sources.length - 1;
        try {
          const response = await fetch('/merge-playlists', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Requested-With': 'XMLHttpRequest',
            },
            body: JSON.stringify({
              target_id: target.id,
              source_ids: [source.id],
              new_name: null,
            }),
          });
          const data = await response.json();
          if (!data.success && data.failures && data.failures.length) {
            hasFailures = true;
          }
          source.li.remove();
        } catch {
          hasFailures = true;
        }
        transferred += source.count || 0;
        if (mergeStatus) {
          mergeStatus.textContent = `Transferring: ${transferred} of ${totalToTransfer}`;
        }
      }
      if (hasFailures) {
        alert('Some playlists could not be merged.');
      }
      const newCount = sorted.reduce((sum, item) => sum + (item.count || 0), 0);
      target.li.dataset.count = `${newCount}`;
      const metaEl = target.li.querySelector('.meta');
      if (metaEl) metaEl.textContent = `${newCount} videos`;
      const checkbox = target.li.querySelector('.playlist-select');
      if (checkbox) checkbox.checked = false;
      mergeSelectedButton.textContent = originalLabel;
      if (mergeStatus) {
        mergeStatus.textContent = 'Merge complete.';
        setTimeout(() => {
          mergeStatus.textContent = '';
        }, 1500);
      }
      updateBulkState();
    }

    if (mergeSelectedButton) {
      mergeSelectedButton.addEventListener('click', startMerge);
    }
    window.startMerge = startMerge;
  </script>
{% endblock %}
